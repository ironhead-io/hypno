# @configure_input@
## --------------------------------------------------------- ##
## Makefile
## 
## @summary
## Contains all the targets necessary to assemble
## Hypno on most machines. 
##
## @author
## Copyright 2022 Ironhead, Inc.
## --------------------------------------------------------- ##
NAME = @PACKAGE_NAME@
VERSION = @PACKAGE_VERSION@
PREFIX = @prefix@
LOGDIR = /var/log
EXEC_PREFIX = @exec_prefix@
BINDIR = @bindir@
WWWROOT = /var/www
srcdir = @srcdir@
VPATH = @srcdir@
SRVUSER = ramar
SRVGROUP = ramar
IFLAGS = -Ivendor -Ivendor/lua-5.4.3/src
#LDFLAGS = -L/usr/lib -L/usr/lib/x86_64-linux-gnu -ldl -lpthread -lm
LDFLAGS = -ldl -lpthread -lm
DEBUGFLAGS = -DDEBUG_H
MODEL = HTHREAD_H
ASAN_OPTIONS = log_path=asan.log
CLANGFLAGS = -Wall -Werror -Wno-unused -Wno-format-security -Wno-unused-result -D$(MODEL) $(IFLAGS)
GCCFLAGS = -Wall -Werror -Wno-unused -Wno-strict-overflow -Wno-unused-result -Wno-strict-aliasing \
	-Wno-format-truncation -Wno-return-local-addr -D$(MODEL) -O2 $(IFLAGS)
CFLAGS = $(GCCFLAGS)
CC = gcc
SRC = \
	@srcdir@/vendor/zrender.c \
	@srcdir@/vendor/ztable.c \
	@srcdir@/vendor/sqlite3.c \
	@srcdir@/vendor/zdb.c \
	@srcdir@/vendor/zwalker.c \
	@srcdir@/vendor/zhttp.c \
	@srcdir@/vendor/zmime.c \
	@srcdir@/vendor/zjson.c \
	@srcdir@/vendor/router.c \
	@srcdir@/src/configs.c \
	@srcdir@/src/lua.c \
	@srcdir@/src/socket.c \
	@srcdir@/src/util.c \
	@srcdir@/src/server.c \
	@srcdir@/src/loader.c \
	@srcdir@/src/xml.c \
	@srcdir@/src/log.c \
	@srcdir@/src/ctx/ctx-http.c \
	@srcdir@/src/ctx/ctx-https.c \
	@srcdir@/src/lua/lib.c \
	@srcdir@/src/lua/db.c \
	@srcdir@/src/lua/echo.c \
	@srcdir@/src/lua/encdec.c \
	@srcdir@/src/lua/lua.c \
	@srcdir@/src/lua/json.c \
	@srcdir@/src/lua/rand.c \
	@srcdir@/src/lua/filesystem.c \
	@srcdir@/src/lua/http.c \
	@srcdir@/src/lua/hash.c \
	@srcdir@/src/filters/filter-static.c \
	@srcdir@/src/filters/filter-echo.c \
	@srcdir@/src/filters/filter-dirent.c \
	@srcdir@/src/filters/filter-redirect.c \
	@srcdir@/src/filters/filter-lua.c
OBJ = ${SRC:.c=.o}
TARGET = main
TESTS = luabind router util
UNAME = $(shell uname)
DOMAIN = localhost 
DISTDIR = $(NAME)-$(VERSION)
FILES = configure LICENSE Makefile.in README.md

# main - Compiles all code needed to get hypno running
#main: vendor/libssl.a
#main: vendor/libcrypto.a
main: vendor/liblua.a
main: CFLAGS += -DNO_HTTPS_SUPPORT
main: $(OBJ)
	-@test -d $(srcdir)/bin/ || mkdir $(srcdir)/bin/
	$(CC) $(CFLAGS) $(srcdir)/src/cli/server.c -o $(srcdir)/bin/$(NAME)-server $(OBJ) $(srcdir)/vendor/liblua.a $(LDFLAGS)
	$(CC) $(CFLAGS) $(srcdir)/src/cli/harness.c -o $(srcdir)/bin/$(NAME)-harness $(OBJ) $(srcdir)/vendor/liblua.a $(LDFLAGS)
	$(CC) $(CFLAGS) $(srcdir)/src/cli/cli.c -o $(srcdir)/bin/$(NAME)-cli $(OBJ) $(srcdir)/vendor/liblua.a $(LDFLAGS)


# main-ssl: Identical to main except with these SSL targets.
main-ssl: vendor/libssl.a
main-ssl: vendor/libcrypto.a
main-ssl: vendor/liblua.a
main-ssl: LDFLAGS += -lgnutls
main-ssl: CFLAGS += -DINCLUDE_GNUTLS
main-ssl: $(OBJ)
	-@test -d $(srcdir)/bin/ || mkdir $(srcdir)/bin/
	$(CC) $(LDFLAGS) $(CFLAGS) $(srcdir)/src/cli/server.c -o $(srcdir)/bin/$(NAME)-server $(OBJ) $(srcdir)/vendor/liblua.a $(srcdir)/vendor/libcrypto.a $(srcdir)/vendor/libssl.a  
	$(CC) $(LDFLAGS) $(CFLAGS) $(srcdir)/src/cli/harness.c -o $(srcdir)/bin/$(NAME)-harness $(OBJ) $(srcdir)/vendor/liblua.a $(srcdir)/vendor/libcrypto.a $(srcdir)/vendor/libssl.a  
	$(CC) $(LDFLAGS) $(CFLAGS) $(srcdir)/src/cli/cli.c -o $(srcdir)/bin/$(NAME)-cli $(OBJ) $(srcdir)/vendor/liblua.a $(srcdir)/vendor/libcrypto.a $(srcdir)/vendor/libssl.a 


#	$(CC) $(LDFLAGS) -llzma -lbz2 -lz $(CFLAGS) $(srcdir)/src/cli/package.c -o $(srcdir)/bin/$(NAME)-package $(OBJ) $(srcdir)/vendor/liblua.a $(srcdir)/vendor/libcrypto.a $(srcdir)/vendor/libssl.a $(srcdir)/vendor/libarchive.a
# debug - Builds code with debugging flags on
debug: debug-clang
	@printf '' > /dev/null


clang: CC = clang
clang: CFLAGS = $(CLANGFLAGS) -g $(DEBUGFLAGS)
clang: vendor/liblua.a
clang: vendor/libssl.a
clang: vendor/libcrypto.a
clang: main
	@printf '' > /dev/null

debug-clang: CC = clang
debug-clang: CFLAGS = $(CLANGFLAGS)
debug-clang: CFLAGS += -g -fsanitize=address -fsanitize-undefined-trap-on-error $(DEBUGFLAGS)
debug-clang: vendor/liblua.a
debug-clang: vendor/libssl.a
debug-clang: vendor/libcrypto.a
debug-clang: main
	@printf '' > /dev/null

debug-gcc: CC = gcc
debug-gcc: CFLAGS += -g -O0 $(DEBUGFLAGS)
debug-gcc: vendor/liblua.a
debug-gcc: vendor/libssl.a
debug-gcc: vendor/libcrypto.a
debug-gcc: main
	@printf '' > /dev/null

debug-fork: main
	@printf '' > /dev/null


# install - Installs targets to $PREFIX/{bin,share} and /var/lib
install:
	cp $(srcdir)/bin/* $(PREFIX)/bin/
	-test -d $(PREFIX)/share/$(NAME)/ || mkdir -p $(PREFIX)/share/$(NAME)/
	test -d $(PREFIX)/share/$(NAME)/
	cp $(srcdir)/share/* $(PREFIX)/share/$(NAME)/
	-test -d /etc/$(NAME) || mkdir -p /etc/$(NAME)/
	cp $(srcdir)/share/etc.hypno.hypno.lua /etc/$(NAME)/hypno.lua
	-mkdir -p $(WEBDIR)/ && chown $(SRVUSER):$(SRVGROUP) $(WEBDIR)/
	-test -d /var/lib/$(NAME)/ || mkdir /var/lib/$(NAME)/
	test -d /var/lib/$(NAME)/
	-cp $(srcdir)/lib/* /var/lib/$(NAME)/
	chown -R $(SRVUSER):$(SRVGROUP) /var/lib/$(NAME)/


# cygwin-install - Installs hypno as a service suitable for use with Cygwin 
cygwin-install:
	cygstart --action=runas cygrunsrv --install hypno --user $(USER) -p /usr/local/bin/hypno-server -a '--start --config /var/www/config.lua'


# systemd-install - Installs systemd on Linux systems
systemd-install:
	sed '{ s#__PREFIX__#$(PREFIX)#; s#__SRVUSER__#$(SRVUSER)#; s#__SRVGROUP__#$(SRVGROUP)#; s#__LOGDIR__#$(LOGDIR)#g; s#__WWWROOT__#$(WWWROOT)# }' \
		$(PREFIX)/share/$(NAME)/etc.systemd.system.hypno.service > /etc/systemd/system/hypno.service



# uninstall - Uninstalls hypno
uninstall:
	-rm -rf /var/lib/$(NAME)/ $(PREFIX)/share/$(NAME)/	
	-rm $(PREFIX)/bin/$(NAME)-{cli,harness,server}


# examples - Runs hypno with the files in example/.  Use -e PORT to change port number.
examples: PORT=2222
examples: $(TARGET) 
examples: 
	@clear
	@lua -e "a=loadfile( 'example/config.lua' )(); \
		hosts = {}; for k,v in pairs(a.hosts) do table.insert( hosts, 'http://' .. k ) end; \
		print( 'Hosts at example/config.lua are:\n' .. table.concat( hosts, '\n' ) );"
	@printf "Starting hypno-server, and listening for requests at port 2222...\n"
	@$(srcdir)/bin/$(NAME)-server \
		--start --port $(PORT) --config $(srcdir)/example/config.lua --user $$USER


vendor/sqlite3.o: CFLAGS+=-Wno-misleading-indentation -Wno-deprecated-declarations
vendor/sqlite3.o:
	$(CC) $(CFLAGS) -lpthread -c -o vendor/sqlite3.o vendor/sqlite3.c


# repl - Build and test libraries for REPL usage
#	test -f sqlite3.o || $(CC) $(CFLAGS) -fPIC -c vendor/sqlite3.c -o shared/sqlite3.o
repl:
	$(CC) $(CFLAGS) -fPIC -c src/database.c -o shared/database.o
	$(CC) $(CFLAGS) -fPIC -c vendor/zhasher.c -o shared/zhasher.o
	$(CC) $(CFLAGS) -fPIC -c src/luabind.c -o shared/luabind.o
	$(CC) $(CFLAGS) -fPIC -c src/lua-db.c -o shared/lua-db.o
	$(CC) -shared $(LDFLAGS) $(CFLAGS) -fPIC -o lib$(NAME).so shared/database.o \
		shared/lua-db.o shared/zhasher.o shared/luabind.o
	lua -l libhypno - < tests/lua-db/dbtest.lua
 
# test -  Build all test files
test: $(OBJ) 
test: CFLAGS += -g -fsanitize=address -fsanitize-undefined-trap-on-error $(DEBUGFLAGS) -DTEST_H
test:
	-@test -d $(srcdir)/bin/ || mkdir $(srcdir)/bin/
	for t in $(TESTS); do $(CC) $(LDFLAGS) $(CFLAGS) -o bin/$$t src/test/$${t}-test.c $(OBJ); done


# test-invoke - Run a test invocation
test-invoke:
	echo sudo ASAN_OPTIONS=$$ASAN_OPTIONS bin/hypno-server --start --port 80 --config ../www/config.lua -x
	sudo ASAN_OPTIONS=$$ASAN_OPTIONS bin/hypno-server --start --port 80 --config ../www/config.lua -x

# vendor/libssl.a - Build OpenSSL
vendor/libssl.a vendor/libcrypto.a &:
	-@cd vendor/ && tar xzf openssl-1.1.1l.tar.gz && cd openssl-1.1.1l && ./config && make && mv libssl.a libcrypto.a ../

# vendor/liblua.a - Build Lua 5.4.3
vendor/liblua.a: 
	-@cd vendor/ && tar xzf lua-5.4.3.tar.gz && \
		cd lua-5.4.3 && make MYCFLAGS="-fPIC" && mv src/liblua.a ../

#	$(CC) $(CFLAGS) -o $(srcdir)/vendor/sqlite3.o -c $(srcdir)/vendor/sqlite3.c 
#	$(CC) $(CFLAGS) -o $(srcdir)/vendor/sqlite3.o -c $(srcdir)/vendor/sqlite3.c 

# clean - Get rid of object files and tests 
clean:
	-@find $(srcdir)/src/ -maxdepth 2 -type f -name "*.o" | xargs rm
	-@find $(srcdir)/bin/ -maxdepth 1 -type f | xargs rm
	-@find $(srcdir)/vendor/ -maxdepth 1 -type f -name "*.o" | xargs rm

#-@find $(srcdir)/vendor/ -maxdepth 1 -type f -name "*.o" ! -name "sqlite3.o" | xargs rm

# list - List all the targets and what they do
list:
	@printf 'Available options are:\n'
	@sed -n '/^# / { s/# //; 1d; p; }' Makefile | awk -F '-' '{ printf "  %-20s - %s\n", $$1, $$2 }'

# plat - Build on a different platform by specifying the target
# figure out host and ping it to see if its running
# either package this or scp -r * to host
# go to host and try to build with commands
# exit
plat:
	make -f build/Makefile.arch boom
	echo $(OS)	
	
#if 0
# stress - Stress test the server
stress: LIMIT=512
stress: URL="http://carolinascholar.com/login?xasdfas=asdfsa" 
stress:
	tests/stress.sh $(LIMIT) $(URL)

# pkg - Make a package of the latest tagged version for distribution
pkg:
	git archive --format tar HEAD | gzip > build/$(NAME)-`git tag | tail -n 1`.tar.gz

# pkgtest - Make a package of the latest version of dev
pkgtest:
	git archive --format tar HEAD | \
		gzip > $(NAME)-`git tag | tail -n 1`.tar.gz

# umakefile - Generate a Makefile appropriate for a regular user
nmakefile:
	@sed '/^# /d' Makefile | cpp - | sed '/^# /d'

# changelog - Generate a full changelog from the commit history
changelog:
	@printf "# CHANGELOG\n\n"
	@printf "## STATS\n\n"
	@printf -- "- Commit count: "
	@git log --full-history --oneline | wc -l
	@printf -- "- Project Inception "
	@git log --full-history | grep Date: | tail -n 1
	@printf -- "- Last Commit "
	@git log -n 1 | grep Date:
	@printf -- "- Authors:\n"
	@git log --full-history | grep Author: | sort | uniq | sed '{ s/Author: //; s/^/\t- /; }'
	@printf "\n"
	@printf "## HISTORY\n\n"
	@git log --full-history --author=Antonio | sed '{ s/^   /- /; }'
	@printf "\n<link rel=stylesheet href=changelog.css>\n"

# Create a package (in a different way)
dist: $(DISTDIR).tar.gz

# Create a package archive 
$(DISTDIR).tar.gz: $(DISTDIR)
	tar chof - $(DISTDIR) | gzip -9 -c > $@	
	rm -rf $(DISTDIR)

# Create a package directory
$(DISTDIR):
	rm -f $(DISTDIR).tar.gz
	rm -rf $(DISTDIR)
	mkdir -p $(DISTDIR)/src \
		$(DISTDIR)/vendor \
		$(DISTDIR)/include \
		$(DISTDIR)/etc \
		$(DISTDIR)/bin \
		$(DISTDIR)/lib
	cp $(FILES) $(DISTDIR)/
	cp -r src/* $(DISTDIR)/src/
	cp -r vendor/*.[ch] vendor/lua-5.4.3 $(DISTDIR)/vendor/

# Check that packaging worked (super useful for other distributions...) 
distcheck:
	gzip -cd $(DISTDIR).tar.gz | tar xvf -
	cd $(DISTDIR) && ./configure
	cd $(DISTDIR) && $(MAKE)
	cd $(DISTDIR) && $(MAKE) clean
	rm -rf $(DISTDIR)
	@echo "*** package $(DISTDIR).tar.gz is ready for distribution."
	
#endif

copyright-update:
	@find src -type f -name "*.[ch]" | \
		xargs sed -i "s/Copyright 2020-$$(( `date +%Y` - 1 ))/Copyright 2020-`date +%Y`/"

docs:
	-@mkdir docs/
	FF=/tmp/readme.`date +%F`.$$RANDOM.md; \
	markdown README.md > $$FF && \
	for n in `grep --line-number 'pre>' $$FF | \
		sed '{ s#<pre>#,#; s#</pre>#|# }' | \
		awk -F ':' '{ printf "%d%s", $$1, $$2 }' | \
		sed '{ s/ //g; s/|/ /g }'`; \
	do \
		L=`echo $$n | awk -F ',' '{ print $$1 }'`; \
		R=`echo $$n | awk -F ',' '{ print $$2 }'`; \
		sed -i "{ \
			$$(( $$L + 1 )),$$(( $$R - 1 ))s/</\&lt/g; \
			$$(( $$L + 1 )),$$(( $$R - 1 ))s/>/\&gt;/g \
		}" $$FF; \
	done && \
	mv $$FF docs/index.html

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

README.md: docs
	printf '' >/dev/null

# By default, we need to be running https
# A command-line for generating self signed certs is below
cert: CERTNAME=cert
cert:
	-mkdir tmp/
	openssl req -x509 -newkey rsa:4096 \
		-keyout tmp/$(CERTNAME).pem \
		-out tmp/$(CERTNAME).crt \
		-days 365 -nodes -subj '/CN=$(DOMAIN)'

.PHONY: docs dist distcheck
